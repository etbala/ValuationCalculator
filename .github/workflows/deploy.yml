# Deploy to AWS App Runner via ECR
name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to Amazon ECR
      run: |
        aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ secrets.ECR_REPOSITORY_URI }}

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.ECR_REPOSITORY_URI }}:latest .

    - name: Push Docker image to Amazon ECR
      run: |
        docker push ${{ secrets.ECR_REPOSITORY_URI }}:latest

    - name: Deploy to AWS App Runner
      run: |
        JSON_PAYLOAD=$(cat <<EOF
        {
          "ImageRepositoryConfiguration": {
            "ImageIdentifier": "${{ secrets.ECR_REPOSITORY_URI }}:latest",
            "ImageRepositoryType": "ECR"
          }
        }
        EOF
        )
        aws apprunner update-service \
          --service-name ${{ secrets.APP_RUNNER_SERVICE_NAME }} \
          --source-configuration "$JSON_PAYLOAD"
